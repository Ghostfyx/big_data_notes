# HDFS Erasure Coding

 ## 1. 宗旨

复制非常昂贵。HDFS中默认的3x复制方案在存储空间和其他资源(例如网络带宽)上有200％的开销。但是，对于具有相对较低I/O活动的冷热数据集，在正常操作期间很少访问其他块副本，但是仍然消耗与第一个副本相同的资源量。

因此，一个自然的改进是使用擦除编码(EC)代替复制。它提供了相同级别的容错能力，而存储空间却少得多。 在典型的擦除编码(EC)设置中，存储开销不超过50％。 EC文件的复制因子没有意义。 它始终为1，无法通过-setrep命令进行更改。

## 2. 背景

在存储系统中，EC最显着的用途是廉价磁盘冗余阵列(RAID)。RAID通过条带化实现EC，条带化将逻辑上连续的数据(例如文件)划分为较小的单位(例如位，字节或块)，并将连续的单位存储在不同的磁盘上。 在本指南的其余部分中，这种条带分布的单位称为条带化单元(或单元)。对于原始数据单元的每个条带，都会计算并存储一定数量的奇偶校验单元，这个过程称为编码。 可以通过基于剩余数据和奇偶校验单元的解码计算来恢复任何条带化单元上的错误。

将EC与HDFS集成可以提高存储效率，同时仍提供与传统的基于复制的HDFS部署类似的数据持久性。 例如，一个具有6个块的3x复制文件将消耗$6\times3 = 18$个磁盘空间。 但是，通过EC(6数据，3奇偶校验)部署，它将仅消耗9块磁盘空间。

## 3. 体系结构

在EC的背景下，条带化具有几个关键优势：

- 启用在线EC(立即以EC格式写入数据)，避免了转换阶段并立即节省了存储空间
- 通过并行利用多个磁盘主轴来增强顺序I/O性能
- 自然地将一个小文件分发到多个DataNode，并且不需要将多个文件捆绑到一个编码组中。 这极大地简化了文件操作，例如删除，配额报告以及联合命名空间之间的迁移

在典型的HDFS群集中，小文件可占总存储消耗的3/4以上。为了更好地支持小文件，HDFS在工作的第一阶段支持带条化的EC。将来，HDFS也将支持连续的EC布局。

- NameNode扩展   条带化HDFS文件在逻辑上由块组组成，每个块组包含一定数量的内部块。 为了减少这些附加块的NameNode内存消耗，引入了新的分层块命名协议。 可以从其任何内部块的ID推断出块组的ID。 这允许在块组而不是块的级别进行管理。

- 客户端扩展  客户端读取和写入路径已得到增强，可以并行处理块组中的多个内部块。在输出/写入路径上，DFSStripedOutputStream管理着一组数据流，每个数据节点在当前块组中存储一个内部块。 数据流异步工作， 协调器负责整个块组的操作，包括结束当前块组，分配新的块组，等等。 在输入/读取路径上，DFSStripedInputStream将请求的逻辑字节数据范围转换为存储在DataNodes上的内部块。 然后，它并行发出读取请求。 发生故障时，它将发出其他读取请求以进行解码。

- DataNode扩展  DataNode运行附加的ErasureCodingWorker（ECWorker）任务，以对失败的擦除编码块进行后台恢复。 NameNode检测到失败的EC块，然后NameNode选择一个DataNode进行恢复工作。 恢复任务作为心跳响应传递。 此过程类似于失败时如何重新复制失效的块。 重建执行三个关键任务：

	1. 从源节点读取数据：使用专用线程池从源节点并行读取输入数据。 基于EC策略，它计划对所有源目标的读取请求，并仅读取最少数量的输入块以进行重建。
	2. 解码数据并生成输出数据：从输入数据解码新数据和奇偶校验块。 所有丢失的数据和奇偶校验块一起解码。
	3. 将生成的数据块传输到目标节点：解码完成后，恢复的块将传输到目标DataNode。

- 擦除编码策略  为了适应异构的工作负载，我们允许HDFS群集中的文件和目录具有不同的复制和擦除编码策略。 擦除编码策略封装了如何对文件进行编码/解码。 每个策略由以下信息定义：

	1. EC模式：包括EC组(例如6 + 3)中的数据和奇偶校验块的数量，以及编解码器算法(例如Reed-Solomon，XOR)
	2. 条带化单元的大小： 决定了条带读取和写入的粒度、缓冲区大小和编码工作。

	策略被命名为编解码器-数据块-奇偶校验-块单元大小。当前，支持五种内置策略：RS-3-2-1024k，RS-6-3-1024k，RS-10-4-1024k，RS-LEGACY-6-3-1024k，XOR-2-1- 1024k。

	还支持默认的REPLICATION策略。它只能在目录上设置，以强制目录采用3倍复制方案，而不继承其祖先的擦除编码策略。此策略可以使3x复制方案目录与擦除编码目录混合使用。