# Transparent Encryption in HDFS

## 1. 概述

HDFS实现了透明的端到端加密。配置完成后，可以透明地加密和解密从特殊HDFS目录读取和写入的数据，而无需更改用户应用程序代码。 这种加密也是端到端的，这意味着数据只能由客户端加密和解密。 HDFS从不存储或访问未加密的数据或未加密的数据加密密钥。 这满足了加密的两个典型要求：静态加密(代表永久存储介质上的数据，例如：磁盘)以及传输中加密(例如，当数据通过网络传输时)。

## 2. 背景

可以在传统数据管理软件/硬件堆栈的不同层上进行加密。 选择在给定层进行加密有不同的优点和缺点：

- **应用层级加密(Application-level encryption)**：最安全，最灵活的方法。 该应用对加密的内容具有最终控制权，并且可以精确反映用户的需求。 但是，编写应用程序来做到这一点很困难。 对于不支持加密的现有应用的客户，这也不是一种选择。
- **数据库层级加密(Database-level encryption)**：就其属性而言，类似于应用程序级加密。 大多数数据库供应商都提供某种形式的加密。 但是，可能存在性能问题。 此外索引不能被加密。
- **文件系统级别加密(Filesystem-level encryption)**：此选项提供高性能，应用程序透明性，并且通常易于部署。 但是，它无法为某些应用程序级加密策略建模。 例如，多租户应用程序可能希望基于最终用户进行加密。 数据库可能希望为单个文件中存储的每个列使用不同的加密设置。
- **磁盘级别加密(Disk-level encryption)**：易于部署和高性能，但也相当不灵活。 只有真正防止物理泄密。

HDFS级别的加密适合上述堆栈中的数据库级别和文件系统级别的加密。它有很多优点： HDFS加密能够提供良好的性能，而现有的Hadoop应用程序能够在加密的数据上透明运行。 在制定策略决策时，HDFS还具有比传统文件系统更多的上下文。

HDFS级别的加密还可以防止在文件系统级别及文件系统以下的攻击，即所谓的OS级别攻击。操作系统和磁盘仅与加密字节进行交互，因为数据已由HDFS加密。

## 2. 用例

许多不同的政府，金融和监管实体都要求数据加密。 例如，医疗保健行业有HIPAA法规，卡支付行业有PCI DSS法规，而美国政府有FISMA法规。 HDFS内置了透明加密，使组织更容易遵守这些法规。

加密也可以在应用程序级别执行。通过将其集成到HDFS中，现有应用程序可以对加密数据进行操作而无需更改程序。 这种集成架构意味着加密文件语义以及与其他HDFS功能的更好协调。

## 3. 体系结构

### 3.1 概述

对于透明加密，介绍HDFS的一个新的抽象概念： **the encryption zone**。加密区域是一个特殊的目录，其内容在写入时将被透明加密，在读取时将被透明解密。 每个加密区域都与创建该区域时指定的单个加密区域密钥相关联。加密区域内的每个文件都有其自己的唯一数据加密密钥(data encryption key，DEK)。 HDFS从不直接处理DEK。 相反，HDFS仅处理加密的数据加密密钥(encrypted data encryption key,EDEK)。客户端解密EDEK，然后使用后续的DEK读取和写入数据。 HDFS数据节点仅看到加密字节流。

加密的一个非常重要的用例是将其打开并确保整个文件系统中的所有文件都已加密。 为了支持这种有力的保障，同时不失去在文件系统的不同部分中使用不同加密区域密钥的灵活性，HDFS允许嵌套加密区域。在一个加密区域创建后(例如：在根目录上)。用户可以使用不同的密钥在其子目录(例如：/home/alice)上创建更多的加密区域。使用最接近的父目录加密区域的密钥生成文件的EDEK。

需要新的群集服务来管理加密密钥：Hadoop密钥管理服务器(KMS)。 在HDFS加密的情况下，KMS履行三项基本职责：

- 提供对存储加密区域密钥的访问
- 生成新的加密数据加密密钥并存储在NameNode上
- 解密供HDFS客户端使用的加密数据加密密钥(注意：是加密数据密钥的加密)

### 3.2 在加密区域内访问数据

当在加密区域内新建文件，NameNode请求KMS生成一个用加密区域的密钥加密的新EDEK。 然后，EDEK作为文件元数据的一部分永久存储在NameNode上。

当在加密区域内读取文件，NameNode为客户端提供文件的EDEK和用于加密EDEK的加密区域密钥版本。随后，客户端请求KMSKMS解密EDEK，其中涉及检查客户端是否有权访问加密区域密钥版本。 假设成功，客户端将使用DEK解密文件的内容。

读写路径的所有上述步骤都是通过DFSClient，NameNode和KMS之间的交互自动发生的。

对加密文件数据和元数据的访问由正常的HDFS文件系统权限控制。 这意味着，如果HDFS受到破坏(例如：通过获得对HDFS超级用户帐户的未授权访问)，则恶意用户只能获得对密文和加密密钥的访问。 但是，由于对加密区域密钥的访问是由KMS和密钥存储上的单独权限集控制的，因此这不会造成安全威胁。