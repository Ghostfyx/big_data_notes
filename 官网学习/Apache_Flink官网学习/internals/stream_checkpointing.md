# Stream checkpointing

## 1. Introduction

Apache Flink提供了一种容错机制，可以一致地恢复数据流应用程序的状态。 该机制可确保即使出现故障，程序的状态最终也将恰好一次反映出数据流中的每条记录。 请注意，有一个开关可以至少将担保降级一次（如下所述）。

容错机制连续保留分布式数据流的快照，对于小状态的流式应用，这些快照非常轻量级，可以在不影响性能的情况下频繁绘制。流应用程序的状态存储在可配置的位置(如主节点或HDFS)。

如果程序发生故障(由于机器、网络或者软件异常)，Flink将停止分布式流处理程序。Flink重新启动操作算子，并将其重置为最新的checkpoint；输入流将重置为状态快照，确保重新启动的并行数据流的任何记录都不属于先前的检查点状态。

注意：默认情况下，检查点是禁用的。

注意：为了使该机制实现其全部保证，数据流源（例如消息队列或代理）必须能够将流后退到定义的最近点。 Apache Kafka具有此功能，Flink与Kafka的连接器利用了此功能。 有关Flink连接器提供的保证的更多信息，请参见数据源和接收器的容错保证。

注意：由于Flink的检查点是通过分布式快照实现的，因此我们可以交替使用快照和检查点一词。

## 2. checkpointing

Flink容错机制的核心部分是绘制分布式数据流和操作员状态的一致快照。 这些快照充当一致的检查点，如果发生故障，系统可以回退到这些检查点。 Flink绘制这些快照的机制在“分布式数据流的轻量级异步快照”中进行了介绍。 它的灵感来自于用于分布式快照的标准Chandy-Lamport算法，并特别针对Flink的执行模型进行了量身定制。

### 2.1 Barriers

Barriers是Flink分布式快照中的核心要素，Barriers注入到Data Stream中，并与记录作一起为数据流的一部分流动。Barriers从不超越记录，它们严格按照顺序排列。 Barriers将数据流中的记录分为进入当前快照的记录集和进入下一个快照的记录集。每个Barrier都有快照的ID，并且快照数据在Barrier之前。Barrier不会中断数据流的流动，因此非常轻便。 来自不同快照的多个Barrier可以同时出现在流中，这意味着各种快照可能同时发生。

![](https://ci.apache.org/projects/flink/flink-docs-release-1.10/fig/stream_barriers.svg)

Stream Barriers在数据源处注入数据流中，快照n的Barrier被注入的点(简称$S_n$)是快照中数据覆盖到的源中的位置。