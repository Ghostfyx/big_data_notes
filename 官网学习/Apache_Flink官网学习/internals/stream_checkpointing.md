# Stream checkpointing

## 1. Introduction

Apache Flink提供了一种容错机制，可以一致地恢复数据流应用程序的状态。 该机制可确保即使出现故障，程序的状态最终也将恰好一次反映出数据流中的每条记录。 请注意，有一个开关可以至少将担保降级一次（如下所述）。

容错机制连续保留分布式数据流的快照，对于小状态的流式应用，这些快照非常轻量级，可以在不影响性能的情况下频繁绘制。流应用程序的状态存储在可配置的位置(如主节点或HDFS)。

如果程序发生故障(由于机器、网络或者软件异常)，Flink将停止分布式流处理程序。Flink重新启动操作算子，并将其重置为最新的checkpoint；输入流将重置为状态快照，确保重新启动的并行数据流的任何记录都不属于先前的检查点状态。

注意：默认情况下，检查点是禁用的。

注意：为了使该机制实现其全部保证，数据流源（例如消息队列或代理）必须能够将流后退到定义的最近点。 Apache Kafka具有此功能，Flink与Kafka的连接器利用了此功能。 有关Flink连接器提供的保证的更多信息，请参见数据源和接收器的容错保证。

注意：由于Flink的检查点是通过分布式快照实现的，因此我们可以交替使用快照和检查点一词。

## 2. checkpointing

Flink容错机制的核心部分是绘制分布式数据流和操作员状态的一致快照。 这些快照充当一致的检查点，如果发生故障，系统可以回退到这些检查点。 Flink绘制这些快照的机制在“分布式数据流的轻量级异步快照”中进行了介绍。 它的灵感来自于用于分布式快照的标准Chandy-Lamport算法，并特别针对Flink的执行模型进行了量身定制。

### 2.1 Barriers

Barriers是Flink分布式快照中的核心要素，Barriers注入到Data Stream中，并与记录作一起为数据流的一部分流动。Barriers从不超越记录，它们严格按照顺序排列。 Barriers将数据流中的记录分为进入当前快照的记录集和进入下一个快照的记录集。每个Barrier都有快照的ID，并且快照数据在Barrier之前。Barrier不会中断数据流的流动，因此非常轻便。 来自不同快照的多个Barrier可以同时出现在流中，这意味着各种快照可能同时发生。

![](https://ci.apache.org/projects/flink/flink-docs-release-1.10/fig/stream_barriers.svg)

Stream Barriers在数据源处注入数据流中，快照n的Barrier被注入的点(简称$S_n$)是快照中数据覆盖到的源中的位置。例如，在Apache Kafka中，此位置将是分区中最后一条记录的偏移量。 此位置$S_n$将报告给检查点协调员(Flink的JobManager)。

然后，Barries随数据流向下流动，当有中间操作从其所有输入流收到快照n的屏障时，它会将快照n的屏障发射到其所有输出流中。一旦Sink操作符(流式DAG的末尾)从其所有输入流接收到Barries n，便将快照n确认给检查点协调器。所有接收器都确认快照后，就认为快照已完成。

一旦快照n完成，该作业将不再向数据源请求$S_n$之前的记录，因为此时这些记录(及其后代记录)将通过整个数据流拓扑。

![](https://ci.apache.org/projects/flink/flink-docs-release-1.10/fig/stream_aligning.svg)

Operator接收多个输入流需要在快照Barriers对齐输入流，上图说明了这一点：

- 操作一旦从输入流接收到接收到快照Barrier n，就无法处理该流中的任何其他记录，直到它从其他输入流接收到快照Barrier n为止，否则，它将混合属于快照n和属于快照n + 1的记录。
- 快照Barrier n的流被暂时搁置。 从这些流接收到的记录将不进行处理，而是放入输入缓冲区中
- 一旦最后一个流接收到Barrier n，Operator将发出所有阻塞的未发送记录，然后自身发出快照Barrier n
- 此后，它将恢复处理所有输入流中的记录，处理输入缓冲中的记录，然后再处理流中的记录。

### 2.2 State

当操作包含任何形式的状态时，该状态也必须是快照的一部分。操作状态以不同的形式出现：

- 用户自定义状态：由转换函数(如map()或filter()函数)创建和修改的状态。
- 系统状态：此状态指的是操作计算中的数据缓冲区。这种状态的一个典型示例是窗口缓冲区，系统在其中收集/汇总窗口的记录，直到窗口结束为止。

操作在从所有输入流接收到所有快照Barriers的时间点，以及在将屏障发送到其输出流之前，对其状态进行快照。 届时，将对进行Barriers之前记录的所有状态进行更新，并且不依赖于当前Barriers后的记录进行的任何更新。由于快照的状态可能很大，因此将其存储在可配置的状态后端中。 默认情况下，这是JobManager的内存，但对于生产用途，应配置分布式可靠存储(例如HDFS)中。存储状态后，操作确认检查点，将快照Barriers发送到输出流中，继续下一个Barriers，由此往复继续。

现在生成的快照包含：

- 对于每个并行流数据源，快照启动时流中的偏移量/位置
- 对于每一个操作，指向作为快照一部分存储的状态的指针

![](../img/checkpointing.svg)

### 2.3 Exactly Once vs. At Least Once

