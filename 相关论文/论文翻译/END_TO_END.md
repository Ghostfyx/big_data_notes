# END-TO-END ARGUMENTS IN SYSTEM DESIGN

## Abstract

本论文提出了分布式系统中各个模块间功能定位的设计原理，称为端到端原理。理论表明，与系统实现低层功能的代价相比，底层功能也许是冗余的或是无价值的(其实是作者认为在较低的层次上实现冗余功能所花费的代价远大于效果)。例如本文中讨论过的位错误恢复、安全加密、避免重复消息、系统崩溃恢复以及传递消息确认。

------

核心思想：在设计一个系统各个层次的功能时，如果把某个功能放到某一层时无法保证功能的完全可靠，那就干脆不要做，除非是为了性能等其他因素考虑。

------

## Introduction

在功能之间选择适当的边界可能是计算机系统设计人员的主要工作。对于系统设计者来说，最重要的工具是能够为功能定位决策提供指导的设计原则。本文讨论一类使用多年但没有明确定义的功能定位/划分理论。但是，随着数据通信网络作为计算机组件的出现，通过更清晰地说明其应用情况和原因形成行功能布局。本文明确表述了这一论点，以便观察其本质并理解其实际范围。这一观点吸引着应用需求，并为在分层系统中向上移动功能提供了理论依据，使其更接近使用该功能的应用程序。从通信网络版本开始思考。

在一个能够通信的系统中，通常会定义一个通信子系统的模块化边界，并定义通信子系统与系统其余部分之间的接口。这样做时，显然会存在一个通过一下几种方式实现的功能列表：由通信子系统实现或客户端实现。作为一种冒险，或者是冗余的，每次运行它们各自的版本。之所以这样做，是因为应用需求为以下各类的观点提供的一个基础：

------

如果只有在通信系统端点应用的帮助下，所讨论的功能才能完全正确地实现。因此，不可能将该功能作为通信系统本身的特征来提供。 有时，通信系统提供的功能的不完整版本可能有助于提高性能(方便使用端进行自主实现和扩展)。

注解：

如果一种机制能在端系统实现，那么就不应该将其在通信系统组件中实现。保证核心组件相对简洁和高效。

------

将这种针对低级函数实现的推理方式称为“端到端理论”。以下各节详细讨论了端到端理论：首先研究一个使用它的典型示例——可靠数据传输功能的问题，并且通过展示功能的范围使得相同的论点可以得以应用。在数据通信系统中，这个范围包括加密、重传信息检测、消息序列、有保证的消息传输、主机错误检测和接收回复。

在更广泛的范围内，这一论点被应用于计算机操作系统的很多其他功能，包括文件系统。然而，如果我们首先考虑的是更为特殊的通信环境，这种检测是容易的。

## End_to_end caretaking

 以安全文件传输问题为例。文件由文件系统存储在计算机A的磁盘中。计算机A通过数据通信网络与计算机B链接，计算机B也具有文件系统和磁盘。 目标是在知道可能发生故障的情况下，将文件不损坏地从计算机A的存储移动到计算机B的存储。在这种情况下，应用程序是文件传输程序，其中一部分在主机A上运行，另一部分在主机B上运行。为了讨论此事务中对文件完整性可能存在的威胁，假定涉及以下特定步骤 ：

1. 在主机A上，文件传输程序调用文件系统从磁盘上读取文件，该文件驻留在多个磁道上。然后文件系统将文件以固定大小的块(独立于磁盘格式)传递给文件传输程序。
2. 同样在主机A处，文件传输程序请求数据通信系统使用某种通信协议来传输文件，通信协议将文件拆分为数据包， 数据包大小通常与文件块大小和磁盘磁道大小不同。
3. 数据通信网络将数据包从计算机A移动至计算机B。
4. 在主机B上，数据通信程序从数据通信协议中删除数据包，并将其包含的数据传递到文件传输应用程序的第二部分，第二部分在主机B中运行。
5. 在主机B中，文件传输程序调用文件系统将接收到的数据保存在主机B的磁盘上。

对于使用上述步骤进行传输的模型，以下是设计者在传输过程中需要考虑的威胁：

1. 该文件尽管最初正确地写入了主机A的磁盘上。但是如果读取，则可能包含错误的数据，可能是由于磁盘存储系统中的硬件故障所致。(HDFS的checksum就是为了校验文件读取的正确性)
2. 文件系统的软件，文件传输程序或数据通信系统可能在主机A或主机B上缓存和复制文件数据时出错
3. 在主机A或主机B上进行缓冲和复制时，硬件处理器或其本地内存可能会出现短暂错误
4. 数据传输系统可能会改变数据包中的数据、丢失数据包或传输多次数据包
5. 在执行未知数量(也许全部)的事务之后，主机中的任何一个都可能在事务过程中部分崩溃。

一个安全的传输程序是如何处理上述威胁的？一个可能的解决方法是在传输过程的每一步使用复本复制、超时和重试，为错误定位、故障恢复等准确定义冗余。目标是将每个单独威胁的可能性降低到可接受的较小值。然而，系统对于威胁2需要编写正确的项目，这是相当困难的，并非所有的正确应用程序由文件传输应用程序员开发。如果假设所有威胁的发生概率相当低，低至系统足以完成有效工作，那么采用暴力方式完成操作(例如每个步骤都重复三遍)似乎是不经济和低效的。

暴力方式传输的替代方法被称为**端到端检查和重试(end-to-end check and retry)**。假设面临上述威胁中的第一个，与每个文件都存储着具有足够冗余度**校验和(checksum)**，可以将文件中未检测到的错误的机会降低到可接受的忽略不计的值。 应用程序按照上述简单步骤将文件从A传输到B。最后的附加步骤是：位于主机B中的文件传输应用程序，将已传输文件复本从磁盘读取到内中，重新计算校验和，然后将值发送给主机A，与主机A中的原始校验和比较。近当两个校验和一致时，文件传输程序才声明事务已提交；若比较失败，则说明传输过程出现了问题，可能会尝试重试。

如果失败相对比较少，这种技术将会第一次重试，偶尔的两三次重传是被允许的；有人可能会认为在一次文件传输中两次或多次失败表明系统的某些部分需要修改。

现在考虑一个通用提案的有用性，即通信系统在内部提供可靠数据传输的保证。 例如：可以通过数据包校验和，序列号检查和内部重试机制提供选择性冗余来实现此保证。经过足够小心的传输，未检测到的误码的可能性可以降低到可以接受的水平。问题关键是种尝试是对通信系统的谨慎文件传输应用是否有用。

答案是可能已经消除了第四个威胁，但是可靠的文件传输应用程序(TAT，大神的形容词用的太好了不知道怎么才能翻译过来)仍必须应对其余的威胁，因此它仍应基于文件的端到端校验和提供自己的重试。而且，如果这样做，则在通信系统中为确保可靠的数据传输而付出的额外努力只是减少了文件传输应用程序的重试频率。 它不会对结果的必然性或正确性产生影响，**因为无论数据传输系统是否可靠，端到端校验和可只能确保正确的文件传输**，即只能保证文件的传输。

------

关键点来了！在分布式架构中，中间件无法确保数据的正确性，只能保证数据传输的效率和可靠性。这是分布式系统模块和角色划分的基石！！不同的层/模块应该保证其职责的单一性。

------

因此，这个论点：为了实现可靠的文件传输，执行传输的应用程序必须提供文件传输的端到端可靠性保证。在这种情况下，用于检测故障的校验和以及重试提交计划是非常可靠的，这样并不会减少应用程序保障可靠性的负担。

## A too-real example

近期麻省理工学院就遇到了这样一个有趣的例子：一个涉及由多个网关连接的本地网络系统在从一个网关到下一网关的每一跳上都使用了数据包校验和，并假设纠正了主要威胁。假设在无差错传输中最主要的威胁是比特冲突。应用程序设计员意识到校验和，假设网络能提供可靠传输，在每个网关存储时没有意识到传输的数据是不被保护的。一个网关计算机产生了暂态误差：从输入到输出缓冲区拷贝数据时，一个字节对发生了互换，以每百万字节这样一个交换频率。在一定时间内，操作系统的许多资源文件在有缺陷的网关中被重复传输。 其中一些源文件被字节交换破坏，他们的所有者被迫做最终的端到端的错误检验：手动的与旧列表比较与改正。

## Performance aspects

