# END-TO-END ARGUMENTS IN SYSTEM DESIGN

## Abstract

本论文提出了分布式系统中各个模块间功能定位的设计原理，称为端到端原理。理论表明，与系统实现低层功能的代价相比，底层功能也许是冗余的或是无价值的(其实是作者认为在较低的层次上实现冗余功能所花费的代价远大于效果)。例如本文中讨论过的位错误恢复、安全加密、避免重复消息、系统崩溃恢复以及传递消息确认。

------

核心思想：在设计一个系统各个层次的功能时，如果把某个功能放到某一层时无法保证功能的完全可靠，那就干脆不要做，除非是为了性能等其他因素考虑。

------

## Introduction

在功能之间选择适当的边界可能是计算机系统设计人员的主要工作。对于系统设计者来说，最重要的工具是能够为功能定位决策提供指导的设计原则。本文讨论一类使用多年但没有明确定义的功能定位/划分理论。但是，随着数据通信网络作为计算机组件的出现，通过更清晰地说明其应用情况和原因形成行功能布局。本文明确表述了这一论点，以便观察其本质并理解其实际范围。这一观点吸引着应用需求，并为在分层系统中向上移动功能提供了理论依据，使其更接近使用该功能的应用程序。从通信网络版本开始思考。

在一个能够通信的系统中，通常会定义一个通信子系统的模块化边界，并定义通信子系统与系统其余部分之间的接口。这样做时，显然会存在一个通过一下几种方式实现的功能列表：由通信子系统实现或客户端实现。作为一种冒险，或者是冗余的，每次运行它们各自的版本。之所以这样做，是因为应用需求为以下各类的观点提供的一个基础：

------

如果只有在通信系统端点应用的帮助下，所讨论的功能才能完全正确地实现。因此，不可能将该功能作为通信系统本身的特征来提供。 有时，通信系统提供的功能的不完整版本可能有助于提高性能(方便使用端进行自主实现和扩展)。

注解：

如果一种机制能在端系统实现，那么就不应该将其在通信系统组件中实现。保证核心组件相对简洁和高效。

------

将这种针对低级函数实现的推理方式称为“端到端理论”。以下各节详细讨论了端到端理论：首先研究一个使用它的典型示例——可靠数据传输功能的问题，并且通过展示功能的范围使得相同的论点可以得以应用。在数据通信系统中，这个范围包括加密、重传信息检测、消息序列、有保证的消息传输、主机错误检测和接收回复。

在更广泛的范围内，这一论点被应用于计算机操作系统的很多其他功能，包括文件系统。然而，如果我们首先考虑的是更为特殊的通信环境，这种检测是容易的。

## End_to_end caretaking

 以安全文件传输问题为例。文件由文件系统存储在计算机A的磁盘中。计算机A通过数据通信网络与计算机B链接，计算机B也具有文件系统和磁盘。 目标是在知道可能发生故障的情况下，将文件不损坏地从计算机A的存储移动到计算机B的存储。在这种情况下，应用程序是文件传输程序，其中一部分在主机A上运行，另一部分在主机B上运行。为了讨论此事务中对文件完整性可能存在的威胁，假定涉及以下特定步骤 ：

1. 在主机A上，文件传输程序调用文件系统从磁盘上读取文件，该文件驻留在多个磁道上。然后文件系统将文件以固定大小的块(独立于磁盘格式)传递给文件传输程序。
2. 同样在主机A处，文件传输程序请求数据通信系统使用某种通信协议来传输文件，通信协议将文件拆分为数据包， 数据包大小通常与文件块大小和磁盘磁道大小不同。
3. 数据通信网络将数据包从计算机A移动至计算机B。
4. 在主机B上，数据通信程序从数据通信协议中删除数据包，并将其包含的数据传递到文件传输应用程序的第二部分，第二部分在主机B中运行。
5. 在主机B中，文件传输程序调用文件系统将接收到的数据保存在主机B的磁盘上。

对于使用上述步骤进行传输的模型，以下是设计者在传输过程中需要考虑的威胁：

1. 该文件尽管最初正确地写入了主机A的磁盘上。但是如果读取，则可能包含错误的数据，可能是由于磁盘存储系统中的硬件故障所致。(HDFS的checksum就是为了校验文件读取的正确性)
2. 文件系统的软件，文件传输程序或数据通信系统可能在主机A或主机B上缓存和复制文件数据时出错
3. 在主机A或主机B上进行缓冲和复制时，硬件处理器或其本地内存可能会出现短暂错误
4. 数据传输系统可能会改变数据包中的数据、丢失数据包或传输多次数据包
5. 在执行未知数量(也许全部)的事务之后，主机中的任何一个都可能在事务过程中部分崩溃。

一个安全的传输程序是如何处理上述威胁的？一个可能的解决方法是在传输过程的每一步使用复本复制、超时和重试，为错误定位、故障恢复等准确定义冗余。目标是将每个单独威胁的可能性降低到可接受的较小值。然而，系统对于威胁2需要编写正确的项目，这是相当困难的，并非所有的正确应用程序由文件传输应用程序员开发。如果假设所有威胁的发生概率相当低，低至系统足以完成有效工作，那么采用暴力方式完成操作(例如每个步骤都重复三遍)似乎是不经济和低效的。

暴力方式传输的替代方法被称为**端到端检查和重试(end-to-end check and retry)**。假设面临上述威胁中的第一个，与每个文件都存储着具有足够冗余度**校验和(checksum)**，可以将文件中未检测到的错误的机会降低到可接受的忽略不计的值。 应用程序按照上述简单步骤将文件从A传输到B。最后的附加步骤是：位于主机B中的文件传输应用程序，将已传输文件复本从磁盘读取到内中，重新计算校验和，然后将值发送给主机A，与主机A中的原始校验和比较。近当两个校验和一致时，文件传输程序才声明事务已提交；若比较失败，则说明传输过程出现了问题，可能会尝试重试。

如果失败相对比较少，这种技术将会第一次重试，偶尔的两三次重传是被允许的；有人可能会认为在一次文件传输中两次或多次失败表明系统的某些部分需要修改。

现在考虑一个通用提案的有用性，即通信系统在内部提供可靠数据传输的保证。 例如：可以通过数据包校验和，序列号检查和内部重试机制提供选择性冗余来实现此保证。经过足够小心的传输，未检测到的误码的可能性可以降低到可以接受的水平。问题关键是种尝试是对通信系统的谨慎文件传输应用是否有用。

答案是可能已经消除了第四个威胁，但是可靠的文件传输应用程序(TAT，大神的形容词用的太好了不知道怎么才能翻译过来)仍必须应对其余的威胁，因此它仍应基于文件的端到端校验和提供自己的重试。而且，如果这样做，则在通信系统中为确保可靠的数据传输而付出的额外努力只是减少了文件传输应用程序的重试频率。 它不会对结果的必然性或正确性产生影响，**因为无论数据传输系统是否可靠，端到端校验和可只能确保正确的文件传输**，即只能保证文件的传输。

------

关键点来了！在分布式架构中，中间件无法确保数据的正确性，只能保证数据传输的效率和可靠性。这是分布式系统模块和角色划分的基石！！不同的层/模块应该保证其职责的单一性。

------

因此，这个论点：为了实现可靠的文件传输，执行传输的应用程序必须提供文件传输的端到端可靠性保证。在这种情况下，用于检测故障的校验和以及重试提交计划是非常可靠的，这样并不会减少应用程序保障可靠性的负担。

## A too-real example

近期麻省理工学院就遇到了这样一个有趣的例子：一个涉及由多个网关连接的本地网络系统在从一个网关到下一网关的每一跳上都使用了数据包校验和，并假设纠正了主要威胁。假设在无差错传输中最主要的威胁是比特冲突。应用程序设计员意识到校验和，假设网络能提供可靠传输，在每个网关存储时没有意识到传输的数据是不被保护的。一个网关计算机产生了暂态误差：从输入到输出缓冲区拷贝数据时，一个字节对发生了互换，以每百万字节这样一个交换频率。在一定时间内，操作系统的许多资源文件在有缺陷的网关中被重复传输。 其中一些源文件被字节交换破坏，他们的所有者被迫做最终的端到端的错误检验：手动的与旧列表比较与改正。

## Performance aspects

但是关键点是低层系统不需要提供完美的可靠性。 考虑一个不太可靠的网络，每发送一百个消息就会丢失一个消息。 上面概述的简单策略是传输文件，然后检查文件是否正确到达，但随着文件长度的增加，其性能会更差。 文件的所有数据包正确到达的概率随文件长度的增加而呈指数下降，因此，预期的文件传输时间随文件长度的增加而呈指数增长。显然，在较低级别上为提高网络可靠性所做的一些努力可能会对应用程序性能产生重大影响。但是关键点是低层不需要提供完美的可靠性。

因此，在数据通信系统中可靠性措施的付出的努力被视作为基于性能的工程交易，而不是对正确性的需求。注意，此处的性能有几个方面。如果通信系统十分不可靠，文件传输应用性能将会受损坏，因为端到端校验和失败后频繁重试。如果通信系统添加了内部可靠性机制，这些机制也存在性能开销：冗余数据增加的带宽开销以及内部一致性检查完成而增加的时间延迟。有小部分原因与这个方向相关，在认为无论通信系统多么可靠，文件传输应用的端到端校验一定要实现。

在低级的子系统中用性能来决策功能定位一定要小心谨慎。有时，通过彻底检查问题，可以在较高水平上实现相同或更好的性能。如果包括在低级子系统中的功能可以以最小的机械扰动执行，那么在低级执行这一功能可能会更有效。但相反的情况可能会发生——在低级执行这一功能会有更大的开销，有以下两个原因：1. 由于底层子系统对许多应用是通用的，因此不需要改功能的应用也需要付出代价。2. 底层子系统可能没有上级系统那么多信息，因此不能高效完成工作。

通常，性能权衡是相当复杂的。再次考虑在不可靠的网络上仔细的文件传输。提高数据包可靠性的常用技术是使用重试协议对每种数据包进行错误检查。该机制可以在通信子系统中或文件传输应用程序中实现。例如，文件传输中的接收者可以定期计算到目前为止已接收到的文件的校验和，并将其发送回发送者。 然后，发送者可以通过重新传输文件的错误部分。

端到端理论不会明确指出将前期校验放在哪一层，因为任一层都可以执行此性能增强工作(只不过是我们要权衡性能与职责单一性)。将前期重试协议放在文件传输应用程序中可简化通信系统，但是可能会增加总成本。因为通信系统由其他应用程序共享，并且每个应用程序现在必须提供自己的可靠性功能。将前期重试协议放置在通信系统中可能会更有效率，因为它可以逐层地在网络内部执行，从而减少了纠正故障所涉及的延迟。同时，可能有一些应用程序发现增强的成本不值得，但是现在没有选择的余地(因为在通信系统内部实现)。要智能地做出此选择，需要大量有关系统实现的信息。

## Other examples of the end-to-end argument

### Delivery guarantees 传输保证

支持分布式应用程序的较低级别子系统提供一个本质上必须在应用程序级别实现的功能可能是在浪费资源与经理，这一基本论点除了可靠的数据传输外，还可以应用于各种功能的定义与界限。对于端到端理论，可能争论最久、最广为人知的是传输确认。对于传递给接收方的每条消息，数据通信网络都可以轻松地向发送方返回确认(ack)，例如，APPANET在传递消息时会返回一个Request For Next Message(RFNM)的数据包。尽管ack可以在网络中作为拥塞控制的一种使用(起初ARPANET拒绝接受到同一目标的另一条消息，直到先前的RFNM已返回)。原因是，确定是否已将邮件传递到目标主机并不是很重要，应用程序想要知道目标主机是否对消息采取了行动。在消息传递之后但在消息请求的操作完成之前，各种各样的异常可能发生。真正需要的确认是一个端到端的确认，它只能由目标应用程序发起((“我做了”或“我没有”)。

另一种获得即时确认消息的策略是使目标主机足够复杂，当其在接受消息传递时，也承担保证目标应用程序对消息采取行动的责任。这可以解决某些应用对端到端ack的需求，但是不能解决所有应用。

对于以下应用程序，仍需要端对端确认：只有在其他主机请求的类似操作成功时，才应执行目标主机请求的操作。这种应用程序需要**两阶段提交协议(2PC)**，这是一种复杂的端到端确认。同样，如果目标应用程序可能失败或拒绝执行所请求的操作，因此可能会产生否定确认，那么仍然可能需要端对端确认。

### Secure transmission of data 传输安全

可以应用端到端参数的另一个领域是数据加密领域。 这里的论点是三重的：

- 首先，如果数据传输系统执行加密和解密，则必须信任它才能安全地管理所需的加密密钥；
-  其次，数据在进入目标节点并散发到目标应用程序时将是明文数据，因此很容易受到攻击；
- 第三，消息的真实性仍必须由应用程序检查。 如果应用程序执行端到端加密，则它将获得所需的身份验证检查；

如果应用程序执行端到端加密，则它会获得所需的身份验证检查，可以满足其密钥管理，并且数据永远不会暴露在应用程序外部。

因此，为了满足应用程序的要求，不需要通信子系统为所有流量提供自动加密。但是，可能需要通过通信子系统对所有流量进行自动加密，以确保采取其他措施-行为异常的用户或应用程序不会故意传输不应公开的信息。系统将对所有数据进行自动加密，这是系统设计人员可以用来确保信息不会在系统外部泄漏的另一种防火墙。注意，这与认证系统用户对数据的特定部分的访问权限是不同的要求。这种网络级别的加密可能非常简单-相同的密钥可以被所有主机使用，并且需要频繁更改密钥。没有每个用户的密钥会使密钥管理问题复杂化。将加密用于应用程序级身份验证和保护是互补的。两种机制都不能完全满足两种要求。