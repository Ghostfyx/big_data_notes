# Streaming 102: 超越批次处理的流处理世界

------

## 1. 简单回顾和路线图

  在Streaming 101中，首先澄清了一些术语，介绍了**有限数据 VS无限数据**。有限数据源具有有限的大小，通常被称为“批处理”数据。无限数据源源可能具有无限大小，通常被称为“流”数据。在后边将会尽量避免使用批处理和流式传输来修饰数据源，因为这些名称带有一些令人误解和限制性的含义。

然后，解释了**批处理和流处理引擎**之间的区别：批处理引擎是设计优先考虑有限数据(现在批处理引擎提供了micro-batch的方式处理流式数据，Spark-Streaming)，而流处理引擎设计用于处理无限数据。目标是在描述执行引擎时使用批处理和流处理。

   定义完术语之后，介绍了与处理有限数据有关的两个重要的基本概念。首先阐述事件时间（事件发生的时间）和处理时间（数据在系统中被处理的时刻）之间的关键区别。这为Streaming 101中提出的主要论文提供了基础：如果关心事件实际发生时间，则必须基于事件的事件时间，而不是处理时间。

   接下来介绍了窗口的概念(即沿时间边界切分数据集)，这是一种常用的方法，用于应对无限数据源的数据处理，无限数据源理论上永远不会结束。窗口策略的最常见且简单的例子是固定和滑动的窗口，更复杂的窗口类型，例如会话窗口(其中窗口由数据本身的特征决定，捕获每个用户的活动会话窗口，会话窗口之后紧接着是用户的不活动期)也比较广泛的用法。

   除了前文中介绍的概念，现在再介绍3个新的概念：

- **Watermark**

Watermark是相对于事件时间的输入完整性的概念。Watermark表示通一个时间X，表示所有事件时间<X的所有数据到到齐了。因此，当处理无限数据源时，Watermark作为进度的度量。

- **Triggers**

触发器是一种由外部条件触发，来表明何时计算窗口结果的机制。触发器可以让我们灵活的选择何时计算结果并发送给下游，而且随着数据的不停的到来，窗口的可以产生多次输出。所以，窗口结束前可以先提供相似结果，并且能够灵活上游数据的变化(可能是上游数据修正或数据延迟到达)，例如，移动场景在某人的离线时，某人的电话记录了各种动作及其事件时间，然后在重新获得连接时继续上传这些事件进行处理。

- **Accumulation**

积累模式指定在同一时间窗口中观察到的多个结果之间的关系。这些结果可能完全相互之间完全独立，或者它们之间可能存在重叠。不同的累积模式具有不同的语义和与计算成本，适用于不同的场景。

   最后，在回答无限数据处理中的4个问题时，更容易搞清楚这些概念和它们之间的关联关系：

- What **计算的结果是什么？**

Pipeline中的转换来决定结果。例如计算总和，构建直方图，训练机器学习模型等等。它也是经典批处理回答的问题。

- Where **在事件时间中的哪个位置计算结果？**

这个问题是通过在Pipeline中使用事件时间窗口来回答的。这包括从Streaming 101(固定，滑动和会话)窗口的常见示例，似乎没有窗口概念的用例（例如，Streaming 101中描述的时间不可知处理;经典批处理也通常属于此类别）和其他更复杂的窗口类型，如时间有限的拍卖。还要注意，它可以包括处理时间窗口，如果在记录到达系统时将入口时间指定为记录的事件时间。

- When **在处理时间中的哪个时刻触发计算结果？**

通过使用Watermark和Trigger来回答这个问题。这个问题有无穷的变化，但最常见的模式是在给定窗口的输入完成时使用Watermak来描绘，触发器允许提前计算结果(对于在窗口完成之前发出的推测性的、部分的结果)和延迟计算结果(Watermark只是预估窗口的数据全部到达,并不是100%确定，在Watermark声明给定窗口的全部到达之后，也有可能会有隶属于该窗口的数据到达)。

- How **如何修正结果？**

这个问题由所使用的累积类型回答：丢弃(其中结果是相互独立和不同的)，累加(后来的结果建立在先前的结果上)，累加和撤销(当前的累加值和上次触发的值撤销一起发送)。