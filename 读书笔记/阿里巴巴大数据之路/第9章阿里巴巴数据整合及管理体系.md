# 第九章 阿里巴巴数据整合及管理体系

面对爆炸式增长的数据，如何建设高效的数据模型和体系，对这些数据进行有序和有结构地分类组织和存储，避免重复建设和数据不一致性，保证数据的规范性， 一直是大数据系统建设不断追求的方向。

OneData 即是阿里巴巴内部进行数据整合及管理的方法体系和工具。阿里巴巴的大数据工程师在这一体系下，构建统一、规范、可共享的全域数据体系，避免数据的冗余和重复建设，规避数据烟囱和不一致性，充分发挥阿里巴巴在大数据海量、多样性方面的独特优势。借助这一统一化数据整合及管理的方法体系，我们构建了阿里巴巴的数据公共层，并可以帮助相似的大数据项目快速落地实现。下面重点介绍OneData 体系和实施方法论。

## 9.1 概述

阿里巴巴集团大数据建设方法论的核心是：从业务架构设计到模型设计，从数据研发到数据服务，做到数据可管理、可追溯、可规避重复建设。目前，阿里巴巴集团数据公共层团队已把这套方法论沉淀为产品，以帮助数据PD 、数据模型师和ETL 工程师建设阿里的大数据。这一体系包含方法论以及相关产品。

### 9.1.1 定位及价值

建设统一的、规范化的数据接入层(ODS)和数据中间层(DWD和DWS)，通过数据服务和数据产品，完成服务于阿里巴巴的大数据系统建设，即数据公共层建设。提供标准化的（ Standard ）、共享的（ Shared ）、数据服务（ Service ）能力，降低数据互通成本，释放计算、存储、人力等资源，以消除业务和技术之痛。

### 9.1.2 体系架构

体系架构图如图9.1 所示。

![](img/9-1.jpg)

​																			**图9.1 休系架构图**

**业务板块：**由于阿里巴巴集团业务生态庞大，所以根据业务的属性划分出几个相对独立的业务板块，业务板块之间的指标或业务重叠性较小。如电商业务板块涵盖淘系、B2B 系和Ali Express 系等。

**规范定义：** 阿里数据业务庞大，结合行业的数据仓库建设经验和阿里数据自身特点，设计出的一套数据规范命名体系，规范定义将会被用在模型设计中。后面章节将会详细说明。

**模型设计：**以维度建模理论为基础，基于维度建模总线架构，构建一致性的维度和事实(进行规范定义)。同时，在落地表模型时，基于阿里自身业务特点， 设计出一套表规范命名体系。后面章节将会详细说明。

## 9.2 规范定义 

规范定义指以维度建模作为理论基础，构建总线矩阵，划分和定义数据域、业务过程、维度、度量/原子指标、修饰类型、修饰词、时间周期、派生指标。

规范定义实例如图9.2 所示。

![](img/9-2.jpg)

​																	**图9_2 规范定义实例**

### 9.2.1 名词术语

名词术语解释如表9.1 所示。

​																		**表9.1 名词术语解释**

| 名词术语      | 解释                                                         |
| ------------- | :----------------------------------------------------------- |
| 数据域        | 指面向业务分析，将业务过程或者维度进行抽象的集合。其中， 业务过程可以概括为一个个不可拆分的行为事件， 在业务过程之下， 可以定义指标；维度是指度量的环境，如买家下单事件，买家是维度。为保障整个体系的生命力， 数据域是需要抽象提炼，并且长期维护和更新的， 但不轻易变动。在划分数据域时， 既能涵盖当前所有的业务需求，又能在新业务进入时无影响地被包含进已有的数据域中和扩展新的数据域 |
| 业务过程      | 指企业的业务活动事件，如下单、支付、退款都是业务过程。请注意，业务过程是一个不可拆分的行为事件，通俗地讲，业务过程就是企业活动中的事件 |
| 时间周期      | 用来明确数据统计的时间范用或者时间点，如最近30 天、自然周、截至当日等 |
| 修饰类型      | 是对修饰词的一种抽象划分。修饰类型从属于某个业务域，如日志域的访问终端类型涵盖无线端、PC 端等修饰词 |
| 修饰词        | 指除了统计维度以外指标的业务场景限定抽象。修饰词隶属于一种修饰类型，如在日志域的访问终端类型下， 有修饰词PC 端、无线端等 |
| 度量/原子指标 | 原子指标和度量含义相同，基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，具有明确业务含义的名词，如支付金额 |
| 维度          | 维度是度盟的环境，用来反映业务的一类属性， 这类属性的集合构成一个维度，也可以成为实体对象。维度属于一个数据域，如地理维度（其中包挤罔家、地区、省以及城市等级别的内容）、时间维度（其中包括年、季、月、周、日等级别的内容） |
| 维度属性      | 维度属性隶属于一个维度， 如地理维度里面的国家名称、同家ID 、省份名称等都属于维度属性 |
| 派生指标      | 派生指标=一个原子指标+多个修饰词(可选)+时间周期。可以理解为对原子指标业务统计范围的圈定。如原子指标： 支付金额，最近1天海外买家支付金额则为=派生指标(最近1天为时间周期， 海外为修饰词， 买家作为维度，而不作为修饰词) |

### 9.2.2 指标体系

在讲述指标时，会涵盖其组成体系（原子指标、派生指标、修饰类型、修饰词、时间周期），将它们作为一个整体来解读。

#### 1. 基本原则

（1）组成体系之间的关系

- 派生指标由原子指标、时间周期修饰词、若干其他修饰词组合得到(见图9.3)。

	![](img/9-3.jpg)

	​														**图9.3 派生指标**

- 原子指标、修饰类型及修饰词，直接归属在业务过程下，其中修饰词继承修饰类型的数据域

- 派生指标可以选择多个修饰词，修饰词之间的关系为“或”或者“且”，由具体的派生指标语义决定

- 派生指标唯一归属一个原子指标，继承原子指标的数据域， 与修饰词的数据域无关

一般而言，事务型指标和存量型指标只会唯一定位到一个业务过程，如果遇到同时有两个行为发生、需要多个修饰词、生成一个派生指标的情况，则选择时间靠后的行为创建原子指标，选择时间靠前的行为创建修饰词。

原子指标有确定的英文字段名、数据类型和算法说明；派生指标要继承原子指标的英文名、数据类型和算法要求。

（2）命名约定

- 命名所用术语。指标命名，尽量使用英文简写，其次是英文， 当指标英文名太长时，可考虑用汉语拼音首字母命名。如中国质造，用zgzc 。在OneData 工具中维护着常用的名词术语，以用来进行命名。
- 业务过程。英文名：用英文或英文的缩写或者中文拼音简写；中文名：具体的业务过程中文即可，如图9.4 所示。

关于存量型指标对应的业务过程的约定：实体对象英文名+stock。如在线会员数、一星会员数等，其对应的业务过程为mbr_stock在线商品数、商品SKU 种类小于5 的商品数，其对应的业务过程为itm_stock 。

- 原子指标。英文名：动作＋度量：中文名：动作＋度量。原子指标必须挂靠在某个业务过程下，如图9.5 所示。

	![](img/9-5.jpg)

	​																**图9.5 原子指标详情**

- 修饰词。只有时间周期才会有英文名，且长度为2 位，加上“ _”为3 位，例如一ld 。其他修饰词无英文名。

阿里巴巴常用的时间周期修饰词如表9.2 所示。

​													**表9.2 阿里巴巴常用的时间周期修饰词**

| 中文名       | 英文名 |
| ------------ | ------ |
| 最近1天      | 1d     |
| 最近3天      | 3d     |
| 最近7天      | 1w     |
| 最近14天     | 2w     |
| 最近30天     | 1m     |
| 最近60天     | 2m     |
| 最近90天     | 3m     |
| 最近180天    | 6m     |
| 180天以前    | bh     |
| 自然周       | cw     |
| 自然月       | cm     |
| 自然季度     | cq     |
| 截止当日     | td     |
| 年初截止当日 | sd     |
| 零点截止当前 | tt     |
| 财年         | fy     |
| 最近一小时   | 1h     |
| 准实时       | ts     |
| 未来7天      | f1w    |
| 未来4周      | f4w    |

派生指标。英文名： 原子指标英文名＋时间周期修饰词(3 位，例如__Id) ＋序号(4 位，例如_001)；中文名：时间周期修饰词＋[其他修饰词]＋原子指标。

为了控制派生指标的英文名称过长，在英文名的理解和规范上做了取舍，所有修饰词的含义都纳入了序号中。序号是根据原子指标＋派生指标自增的。

（3）算法

原子指标、修饰词、派生指标的算法说明必须让各种使用人员看得明白，包括：

- 算法概述一一算法对应的用户容易理解的阐述。
- 举例一一通过具体例子帮助理解指标算法。
- SQL 算法说明一一对于派生指标给出SQL 的写法或者伪代码。

##### 2. 操作细则

（1）派生指标的种类

派生指标可以分为三类：事务型指标、存量型指标和复合型指标。按照其特性不同，有些必须新建原子指标。有些可以在其他类型原子指标的基础上增加修饰词形成派生指标。

- 事务型指标：是指对业务活动进行衡量的指标。例如新发商品数、重发商品数、新增注册会员数、订单支付金额，这类指标需维护原子指标及修饰词，在此基础上创建派生指标。
- 存量型指标：是指对实体对象(如商品、会员)某些状态的统计。例如商品总数、注册会员总数，这类指标需维护原子指标及修饰词，在此基础上创建派生指标，对应的时间周期一般为“历史截至当前某个时间”。
- 复合型指标：是在事务型指标和存量型指标的基础上复合而成的。例如浏览UV－下单买家数转化率有些需要创建新原子指标，有些则可以在事务型或存量型原子指标的基础上增加修饰词得到派生指标。

（2）复合型指标规则

- 比率型：创建原子指标，如CTR(Click-Through-Rate) 、浏览UV-下单买家数转化率、满意率等。例如，“最近1天店铺首页CTR"，原子指标为“CTR”，时间周期为“最近一天”，修饰类型为“页面类型”，修饰词为“店铺首页”。
- 比例型： 创建原子指标，如百分比、占比。例如“ 最近1 天无线支付金额占比”，原子指标为“支付金额占比”，修饰类型为“终端类型”，修饰词为“无线”。
- 变化量类型：不创建原子指标，增加修饰词，在此基础上创建派生指标。例如，“最近l 天订单支付金额上1天变化量”，原子指标为“订单支付金额”，时间周期为“最近1 天”，修饰类型为“统计方法”，修饰词为“上1 天变化量”。
- 变化率类型：创建原子指标。例如，“最近7 天海外买家支付金额上7 天变化率”，原子指标为“支付金额变化率”，修饰类型为“买家地域”，修饰词为“海外买家”。
- 统计类型(均值、分位数等)：不创建原子指标，增加修饰词，在此基础上创建派生指标；在修饰类型“统计方法”下增加修饰词，如人均、日均、行业平均、商品平均、90 分位数、70 分位数等。例如，“自然月日均UV ”，原子指标为“ UV ”，修饰类型为“统计方法”，修饰词为“日均”。
- 排名类型：创建原子指标，一般为top_xxx_xxx，有时会同时选择rank 和top_ xxx xxx 组合使用。创建派生指标时选择对应的修饰词如下：
	- 统计方法(如降序、升序)
	- 排名名词(如TOP10)
	- 排名范围(如行业、省份、一级来源等)
	- 根据什么排序(如搜索次数、PV)

- 对象集合型：主要是指数据产品和应用需要展现数据时，将一些对象以k-v对的方式存储在一个字段中，方便前端展示。比如趋势图、TOP 排名对象等。其定义方式是，创建原子指标， 一般为xxx 串：创建派生指标时选择对应的修饰词如下：
	 - 统计方法(如降序、升序)
	 - 排名名词(如TOP10)
	 - 排名范围(如行业、省份、一级来源等)

##### 3. 其他规则

（1）上下层级派生指标同时存在时

如最近l 天支付金额和最近l 天PC 端支付金额，建议使用前者，把PC 端作为维度属性存放在物理表中体现。

（2）父子关系原子指标对存在时

当父子关系原子指标存在时，派生指标使用子原子指标创建派生指标。如PV 、IPV(商品详情页PV )，当统计商品详情页PV 时，优先选择子原子指标。

## 9.3 模型设计

### 9.3.1 指导理论

参考Start Schema The Complete Reference 和The Dαtα Warehouse Toolkit-The Definitive Guide to Dimensional Modeling。数据模型的维度设计主要以维度建模理论为基础，基于维度数据模型总线架构，构建一致性的维度和事实。

### 9.3.2 模型层次

阿里巴巴数据团队把表数据模型分为三层：操作数据层(ODS)、公共维度模型层(CDM)和应用数据层(ADS )，其中公共维度模型层包括明细数据层(DWD)和汇总数据层(DWS)。模型层次关系如图9.9 所示。

**操作数据层(ODS)**：把操作系统数据几乎无处理地存放在数据仓库系统中。

- 同步：结构化数据增量(拉链表)或全量同步
- 结构化：非结构化数据(例如：日志)经过结构化处理并存储
- 累积历史、清洗：根据数据业务需求及稽核和审计要求保存历史数据(将历史数据定期转存至历史分区)、清洗数据。