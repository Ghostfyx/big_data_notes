# qChap06 Moving-Average 移动平均

## 1. 移动平均概念

理解移动平均首先要理解时间序列，时间序列数据表示一个变量在一定时间周期内的值，比如一天，一周，一个月等等。将时间序列数据简单表示为：
$$
(k, t, v)
$$
k表示关注点，t表示时间戳，v表示数据值。多个连续周期的时间序列数据平均值（按照相同时间间隔得到的观察值）称为移动平均。

## 2. 股票数据示例

​                                                               表1 股票收盘价格时间序列

| 时间序列 | 日期       | 收盘价 |
| -------- | ---------- | ------ |
| 1        | 2013-10-01 | 1      |
| 2        | 2013-10-02 | 2      |
| 3        | 2013-10-03 | 3      |
| 4        | 2013-10-04 | 4      |
| 5        | 2013-10-05 | 5      |
| 6        | 2013-10-06 | 6      |
| 7        | 2013-10-07 | 7      |

​                                            表2 股票收盘价格移动平均计算 假设时间窗口为3

| 时间序列 | 日期       | 收盘价 | 移动平均计算 |
| -------- | ---------- | ------ | ------------ |
| 1        | 2013-10-01 | 1      | = 1/1        |
| 2        | 2013-10-02 | 2      | =(1+2)/2     |
| 3        | 2013-10-03 | 3      | =(1+2+3)/3   |
| 4        | 2013-10-04 | 4      | =(2+3+4)/3   |
| 5        | 2013-10-05 | 5      | =(3+4+5)/3   |
| 6        | 2013-10-06 | 6      | =(4+5+6)/3   |
| 7        | 2013-10-07 | 7      | =(5+6+7)/3   |

## 3. 形式定义

令A为一组有序对象序列
$$
A = \{a_1, a_2, \dots, a_N\}
$$
可以将A表示为：
$$
\{a_i\}_{i=1}^{N}
$$
n移动平均序列是由$a_i$定义的一个新序列：
$$
\{S_i\}_{i=1}^{N-n+1}
$$
这是通过计算n项子序列的平均值得到的：
$$
S_i = \frac{1}{n}\sum_{j=i}^{i+n-1}a_j
$$
所以n的移动平均为：
$$
S_2 = \frac{1}{2}[(a_1+a_2),(a_2+a_3),...,(a_{N-1}+a_N)] \\

S_3 = \frac{1}{3}[(a_1+a_2+a_3),(a_2+a_3+a_4),...,(a_{N-2}+a_{N-1}+a_N)]
$$

## 4. 移动平均实现方案

### 4.1 POJO实现

#### 4.1.1 方案1-队列

使用队列作为移动窗口的数据结构，以FIFO的方式向队列中新增数据，直到其中包含n个数据，然后不断将其头部元素出队；

#### 4.1.2 方案2-数组

使用队列作为移动窗口的数据结构，以FIFO的方式向队列中新增数据，直到其中包含n个数据，然后不断将其头部元素出队；

### 4.2 Hadoop/MapReduce实现

**输入数据格式**

```xml
<name-as-string><,><date-as-timestamp><,><value>
```

**输出数据格式**

```xml
<name-as-string><,><date-as-timestamp><,><moving-average>
```

#### 4.2.1 二次排序思想实现

在第一章和第二章介绍过MapReduce框架在shuffle阶段完成数据排序，称之为**二次排序**。本章使用二次排序思想将股票数据按照name和timestamp分区排序后，再对价格进行移动平均的计算。

表3 Hadoop实现类

| 类名                           | 类描述                                                  |
| ------------------------------ | ------------------------------------------------------- |
| CompositeKey                   | 定制组合键 (name, timestamp)                            |
| CompositeKeyGroupingComparator | 在Hadoop的shuffle阶段按组合键中的自然键部分对组合键分组 |
| CompositeKeyPartitioner        | 映射阶段的数据输出在发送至shuffle阶段先分区             |
| SortByMRF_MovingAverageMapper  | 映射器                                                  |
| SortByMRF_MovingAverageReducer | 归约器                                                  |
| TimeSeriesData                 | 将时间序列数据表示为二元组形式                          |
| SortByMRF_MovingAverageDriver  | 作业驱动程序                                            |

## 4.3 Spark实现

