# 第一章 初识Kafka

## 1.1 发布与订阅消息系统

在正式讨论 Apache Kafka(以下简称 Kafka)之前，先来了解发布与订阅消息系统的概念， 并认识这个系统的重要性。数据(消息)的发送者(发布者)不会直接把消息发送给接收 者，这是发布与订阅消息系统的一个特点。发布者以某种方式对消息进行分类，接收者(订阅者)订阅它们，以便接收特定类型的消息。发布与订阅系统一般会有一个broker，也就是发布消息的中心点。

### 1.1.1 如何开始

发布与订阅消息系统的大部分应用场景都是从一个简单的消息队列或一个进程间通道开始的。例如，你的应用程序需要往别处发送监控信息，可以直接在你的应用程序和另一个可 以在仪表盘上显示度量指标的应用程序之间建立连接，然后通过这个连接推送度量指标， 如图 1-1 所示。

![](img/1-1.jpg)

​																		**图 1-1:单个直连的度量指标发布者**

这是刚接触监控系统时简单问题的应对方案。过了不久，你需要分析更长时间片段的度量 指标，而此时的仪表盘程序满足不了需求，于是，你启动了一个新的服务来接收度量指 标。该服务把度量指标保存起来，然后进行分析。与此同时，你修改了原来的应用程序， 把度量指标同时发送到两个仪表盘系统上。现在，你又多了 3 个可以生成度量指标的应用 程序，它们都与这两个服务直接相连。而你的同事认为最好可以对这些服务进行轮询以便 获得告警功能，于是你为每一个应用程序增加了一个服务器，用于提供度量指标。再过一 阵子，有更多的应用程序出于各自的目的，都从这些服务器获取度量指标。这时的架构看 起来就像图 1-2 所示的那样，节点间的连接一团糟。

![](img/1-2.jpg)

​																	**图 1-2:多个直连的度量指标发布者**

这时，技术债务开始凸显出来，于是你决定偿还掉一些。你创建了一个独立的应用程序， 用于接收来自其他应用程序的度量指标，并为其他系统提供了一个查询服务器。这样，之 前架构的复杂度被降低到图 1-3 所示的那样。那么恭喜你，你已经创建了一个基于发布与 订阅的消息系统。

![](img/1-3.jpg)

​																			**图 1-3:度量指标发布与订阅系统**

### 1.1.2 独立的队列系统

在你跟度量指标打得不可开交的时候，你的一个同事也正在跟日志消息奋战。还有另一个 同事正在跟踪网站用户的行为，为负责机器学习开发的同事提供信息，同时为管理团队生 成报告。你和同事们使用相同的方式创建这些系统，解耦信息的发布者和订阅者。图 1-4 所示的架构包含了 3 个独立的发布与订阅系统。

![](img/1-4.jpg)

​																					**图 1-4:多个发布与订阅系统**

这种方式比直接使用点对点的连接(图 1-2)要好得多，但这里有太多重复的地方。公司因此要为数据队列维护多个系统，每个系统又有各自的缺陷和不足。而且，接下来可 能会有更多的场景需要用到消息系统。此时，真正需要的是一个单一的**集中式发布订阅系统**，它可以用来发布通用类型的数据，其规模可以随着公司业务的增长而增长。

## 1.2 Kafka登场

Kafka就是为了解决上述问题而设计的一款基于发布与订阅的消息系统。它一般被称为 “分布式提交日志”或者“分布式流平台”。文件系统或数据库提交日志用来提供所有事务 的持久记录，通过重放这些日志可以重建系统的状态。同样地，Kafka 的数据是按照一定 顺序持久化保存的，可以按需读取。此外，Kafka 的数据分布在整个系统里，具备数据故障保护和性能伸缩能力。

### 1.2.1 消息和批次

Kafka 的数据单元被称为**消息**。如果在使用 Kafka 之前已经有数据库使用经验，那么可以把消息看成是数据库里的一个“数据行”或一条“记录”。消息由字节数组组成，所以对于Kafka来说，消息里的数据没有特别的格式或含义。消息可以有一个可选的元数据， 也就是键。键也是一个字节数组，与消息一样，对于Kafka 来说也没有特殊的含义。当消息以一种可控的方式写入不同的分区时，会用到键。最简单的例子就是为键生成一个一致性散列值，然后使用散列值对主题分区数进行取模，为消息选取分区。这样可以保证具有相同键的消息总是被写到相同的分区上。第 3 章将详细介绍键的用法。这样就是为什么要使用唯一键来区分发送消息。

为了提高效率，消息被分批次写入Kafka。批次就是一组消息，这些消息属于同一个主题 和分区。如果每一个消息都单独穿行于网络，会导致大量的网络开销，把消息分成**批次传输可以减少网络开销**。不过，这要在**时间延迟和吞吐量之间作出权衡**：批次越大，单位时 间内处理的消息就越多，单个消息的传输时间就越长。批次数据会被压缩，这样可以提升数据的传输和存储能力，但要做更多的计算处理。